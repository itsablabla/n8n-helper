/**
 * @garza/n8n-helper - Simple wrapper for n8n API
 * 
 * Makes it easy for any program to create and manage n8n workflows
 * without dealing with raw API calls or workflow JSON complexity.
 */

const https = require('https');
const http = require('http');

class N8nHelper {
  constructor(config = {}) {
    // Parse URL to get base
    const url = new URL(config.baseUrl || 'https://garza-n8n.fly.dev');
    
    this.config = {
      baseUrl: config.baseUrl || 'https://garza-n8n.fly.dev',
      apiKey: config.apiKey,
      host: url.hostname,
      port: url.port || (url.protocol === 'https:' ? 443 : 80),
      protocol: url.protocol.replace(':', ''),
      silent: config.silent || false, // Silent mode - no notifications during setup
    };
  }

  /**
   * Create a simple webhook workflow with one action
   * Returns webhook URL immediately
   */
  async createWebhook(options) {
    const {
      name,
      path,
      silent = this.config.silent,
      action = null, // 'claude', 'beeper', 'email', or custom node config
      activate = true
    } = options;

    // Generate webhook path if not provided
    const webhookPath = path || `/webhook/${name.toLowerCase().replace(/\s+/g, '-')}`;

    // Build workflow JSON
    const workflow = this._buildWebhookWorkflow(name, webhookPath, action, silent);

    // Create workflow via API
    const created = await this._apiCall('POST', '/workflows', workflow);

    // Activate if requested
    if (activate && created.id) {
      await this._apiCall('PATCH', `/workflows/${created.id}`, { active: true });
    }

    return {
      workflowId: created.id,
      webhookUrl: `${this.config.baseUrl}${webhookPath}`,
      status: activate ? 'active' : 'inactive'
    };
  }

  /**
   * Quick patterns - common workflow templates
   */
  async createPattern(patternName, config) {
    const patterns = {
      // Webhook → Claude → Beeper
      'webhook-claude-beeper': () => this._buildClaudeBeeperPattern(config),
      
      // Webhook → Process → Store
      'webhook-process-store': () => this._buildProcessStorePattern(config),
      
      // Webhook → Notify (simple notification)
      'webhook-notify': () => this._buildNotifyPattern(config),
    };

    if (!patterns[patternName]) {
      throw new Error(`Unknown pattern: ${patternName}. Available: ${Object.keys(patterns).join(', ')}`);
    }

    const workflow = patterns[patternName]();
    const created = await this._apiCall('POST', '/workflows', workflow);

    if (config.activate !== false) {
      await this._apiCall('PATCH', `/workflows/${created.id}`, { active: true });
    }

    return {
      workflowId: created.id,
      webhookUrl: `${this.config.baseUrl}${workflow.nodes[0].webhookPath}`,
      status: config.activate !== false ? 'active' : 'inactive'
    };
  }

  /**
   * List all workflows
   */
  async listWorkflows() {
    return this._apiCall('GET', '/workflows');
  }

  /**
   * Get specific workflow
   */
  async getWorkflow(id) {
    return this._apiCall('GET', `/workflows/${id}`);
  }

  /**
   * Activate/deactivate workflow
   */
  async setActive(id, active) {
    return this._apiCall('PATCH', `/workflows/${id}`, { active });
  }

  /**
   * Delete workflow
   */
  async deleteWorkflow(id) {
    return this._apiCall('DELETE', `/workflows/${id}`);
  }

  /**
   * Trigger a webhook
   */
  async triggerWebhook(path, data) {
    const url = `${this.config.baseUrl}${path}`;
    return this._httpRequest('POST', url, data);
  }

  // ============ PRIVATE METHODS ============

  _buildWebhookWorkflow(name, path, action, silent) {
    const nodes = [
      {
        parameters: {
          httpMethod: 'POST',
          path,
          responseMode: 'onReceived',
          options: {}
        },
        name: 'Webhook',
        type: 'n8n-nodes-base.webhook',
        typeVersion: 1,
        position: [250, 300],
        webhookId: this._generateId()
      }
    ];

    let position = [450, 300];

    // Add action node if specified
    if (action) {
      if (typeof action === 'string') {
        // Preset action
        if (action === 'claude') {
          nodes.push(this._claudeNode(position));
        } else if (action === 'beeper') {
          nodes.push(this._beeperNode(position));
        }
      } else {
        // Custom node config
        nodes.push({ ...action, position });
      }
    }

    // Add silent mode notification suppression if needed
    if (!silent) {
      // Notifications are on - workflow can send messages
    }

    return {
      name,
      nodes,
      connections: this._connectNodes(nodes),
      active: false,
      settings: {
        executionOrder: 'v1'
      },
      tags: [{ name: 'garza-sdk', id: this._generateId() }]
    };
  }

  _buildClaudeBeeperPattern(config) {
    const path = config.path || `/webhook/${(config.name || 'claude-beeper').toLowerCase().replace(/\s+/g, '-')}`;
    
    return {
      name: config.name || 'Claude to Beeper',
      nodes: [
        {
          parameters: {
            httpMethod: 'POST',
            path,
            responseMode: 'onReceived'
          },
          name: 'Webhook',
          type: 'n8n-nodes-base.webhook',
          typeVersion: 1,
          position: [250, 300],
          webhookId: this._generateId()
        },
        {
          parameters: {
            resource: 'chat',
            operation: 'completion',
            model: 'claude-sonnet-4-20250514',
            text: `={{ $json.prompt || "Process this data" }}`,
            options: {
              maxTokens: 4000
            }
          },
          name: 'Claude AI',
          type: 'n8n-nodes-base.anthropic',
          typeVersion: 1,
          position: [450, 300]
        },
        {
          parameters: {
            chatId: config.chatId || '!required',
            text: `={{ $json.response }}`
          },
          name: 'Beeper',
          type: 'n8n-nodes-base.httpRequest',
          typeVersion: 1,
          position: [650, 300]
        }
      ],
      connections: {
        'Webhook': { main: [[{ node: 'Claude AI', type: 'main', index: 0 }]] },
        'Claude AI': { main: [[{ node: 'Beeper', type: 'main', index: 0 }]] }
      },
      active: false,
      settings: { executionOrder: 'v1' },
      tags: [{ name: 'garza-sdk-pattern', id: this._generateId() }]
    };
  }

  _buildNotifyPattern(config) {
    const path = config.path || `/webhook/${(config.name || 'notify').toLowerCase().replace(/\s+/g, '-')}`;
    
    return {
      name: config.name || 'Simple Notification',
      nodes: [
        {
          parameters: {
            httpMethod: 'POST',
            path,
            responseMode: 'onReceived'
          },
          name: 'Webhook',
          type: 'n8n-nodes-base.webhook',
          typeVersion: 1,
          position: [250, 300],
          webhookId: this._generateId()
        },
        {
          parameters: {
            chatId: config.chatId || '!required',
            text: `={{ $json.message || JSON.stringify($json) }}`
          },
          name: 'Send Notification',
          type: 'n8n-nodes-base.httpRequest',
          typeVersion: 1,
          position: [450, 300]
        }
      ],
      connections: {
        'Webhook': { main: [[{ node: 'Send Notification', type: 'main', index: 0 }]] }
      },
      active: false,
      settings: { executionOrder: 'v1' },
      tags: [{ name: 'garza-sdk-pattern', id: this._generateId() }]
    };
  }

  _claudeNode(position) {
    return {
      parameters: {
        resource: 'chat',
        operation: 'completion',
        model: 'claude-sonnet-4-20250514',
        text: `={{ $json.prompt }}`,
        options: {}
      },
      name: 'Claude AI',
      type: 'n8n-nodes-base.anthropic',
      typeVersion: 1,
      position
    };
  }

  _beeperNode(position) {
    return {
      parameters: {
        method: 'POST',
        url: 'https://api.beeper.com/messages',
        options: {}
      },
      name: 'Beeper',
      type: 'n8n-nodes-base.httpRequest',
      typeVersion: 1,
      position
    };
  }

  _connectNodes(nodes) {
    const connections = {};
    for (let i = 0; i < nodes.length - 1; i++) {
      connections[nodes[i].name] = {
        main: [[{ node: nodes[i + 1].name, type: 'main', index: 0 }]]
      };
    }
    return connections;
  }

  _generateId() {
    return Math.random().toString(36).substring(2, 15);
  }

  // API call helper
  _apiCall(method, path, body = null) {
    return new Promise((resolve, reject) => {
      const options = {
        hostname: this.config.host,
        port: this.config.port,
        path: `/api/v1${path}`,
        method,
        headers: {
          'X-N8N-API-KEY': this.config.apiKey,
          'Content-Type': 'application/json'
        }
      };

      const client = this.config.protocol === 'https' ? https : http;
      const req = client.request(options, (res) => {
        let data = '';
        res.on('data', chunk => data += chunk);
        res.on('end', () => {
          try {
            const parsed = JSON.parse(data);
            if (res.statusCode >= 400) {
              reject(new Error(`API Error ${res.statusCode}: ${JSON.stringify(parsed)}`));
            } else {
              resolve(parsed.data || parsed);
            }
          } catch (e) {
            if (res.statusCode >= 400) {
              reject(new Error(`HTTP ${res.statusCode}: ${data}`));
            } else {
              resolve(data);
            }
          }
        });
      });

      req.on('error', reject);
      
      if (body) {
        req.write(JSON.stringify(body));
      }
      
      req.end();
    });
  }

  _httpRequest(method, url, body) {
    return new Promise((resolve, reject) => {
      const urlObj = new URL(url);
      const client = urlObj.protocol === 'https:' ? https : http;
      
      const options = {
        hostname: urlObj.hostname,
        port: urlObj.port,
        path: urlObj.pathname + urlObj.search,
        method,
        headers: {
          'Content-Type': 'application/json'
        }
      };

      const req = client.request(options, (res) => {
        let data = '';
        res.on('data', chunk => data += chunk);
        res.on('end', () => {
          try {
            resolve(JSON.parse(data));
          } catch (e) {
            resolve(data);
          }
        });
      });

      req.on('error', reject);
      
      if (body) {
        req.write(JSON.stringify(body));
      }
      
      req.end();
    });
  }
}

module.exports = N8nHelper;
